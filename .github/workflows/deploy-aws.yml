name: Deploy to AWS (EC2 + S3)

on:
  push:
    branches:
      - production-main
  workflow_dispatch:  # Allow manual trigger from GitHub UI

env:
  NODE_VERSION: '18.x'
  AWS_REGION: 'us-east-1'  # Change to your AWS region

jobs:
  # =====================================================
  # JOB 1: Build Backend
  # =====================================================
  build-backend:
    name: üî® Build Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: üì¶ Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: üß™ Run backend tests (if available)
        working-directory: ./backend
        run: npm test || echo "‚ö†Ô∏è No tests found, skipping..."
        continue-on-error: true

      - name: üìã Create backend artifact
        run: |
          cd backend
          echo "Creating deployment package..."
          tar -czf ../backend-build.tar.gz \
            --exclude='node_modules' \
            --exclude='.env' \
            --exclude='*.log' \
            --exclude='uploads/*' \
            --exclude='tests' \
            --exclude='.git' \
            .
          cd ..
          echo "‚úÖ Backend artifact created: $(du -h backend-build.tar.gz | cut -f1)"

      - name: üì§ Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend-build.tar.gz
          retention-days: 1

  # =====================================================
  # JOB 2: Build Frontend
  # =====================================================
  build-frontend:
    name: üî® Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üü¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: üì¶ Install frontend dependencies
        working-directory: ./frontend
        run: npm ci

      - name: üèóÔ∏è Build frontend for production
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          CI: false  # Treat warnings as warnings, not errors
          GENERATE_SOURCEMAP: false  # Disable source maps for production
        run: |
          echo "Building frontend..."
          npm run build
          echo "‚úÖ Build complete"
          echo "Build size: $(du -sh build | cut -f1)"

      - name: üì§ Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build
          retention-days: 1

  # =====================================================
  # JOB 3: Deploy Backend to EC2
  # =====================================================
  deploy-backend:
    name: üöÄ Deploy Backend to EC2
    needs: build-backend
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-build

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üì§ Copy artifact to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: backend-build.tar.gz
          target: /tmp/

      - name: üîß Deploy and Configure Backend on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 30m
          script: |
            set -e  # Exit on any error
            
            echo "============================================"
            echo "üöÄ Starting Backend Deployment"
            echo "============================================"
            
            # Set deployment directory
            DEPLOY_DIR="/home/${{ secrets.EC2_USERNAME }}/sgt-lms"
            BACKEND_DIR="$DEPLOY_DIR/backend"
            
            # Create deployment directory if it doesn't exist
            mkdir -p $DEPLOY_DIR
            cd $DEPLOY_DIR
            
            # Stop existing application
            echo "‚è∏Ô∏è  Stopping existing application..."
            pm2 stop sgt-backend 2>/dev/null || echo "No existing process to stop"
            
            # Backup current version
            if [ -d "$BACKEND_DIR" ]; then
              echo "üíæ Creating backup..."
              BACKUP_FILE="backup-$(date +%Y%m%d-%H%M%S).tar.gz"
              tar -czf "$BACKUP_FILE" backend 2>/dev/null || true
              # Keep only last 3 backups
              ls -t backup-*.tar.gz 2>/dev/null | tail -n +4 | xargs -r rm
              echo "‚úÖ Backup created: $BACKUP_FILE"
            fi
            
            # Preserve important files
            echo "üì¶ Preserving uploads, logs, and environment..."
            if [ -d "$BACKEND_DIR/uploads" ]; then
              mv "$BACKEND_DIR/uploads" /tmp/uploads_backup || true
            fi
            if [ -f "$BACKEND_DIR/.env" ]; then
              cp "$BACKEND_DIR/.env" /tmp/env_backup || true
            fi
            
            # Remove old backend
            echo "üßπ Cleaning old deployment..."
            rm -rf "$BACKEND_DIR"
            mkdir -p "$BACKEND_DIR"
            
            # Extract new version
            echo "üì¶ Extracting new backend..."
            cd "$BACKEND_DIR"
            tar -xzf /tmp/backend-build.tar.gz
            rm /tmp/backend-build.tar.gz
            
            # Restore preserved files
            echo "‚ôªÔ∏è  Restoring preserved files..."
            if [ -d "/tmp/uploads_backup" ]; then
              mv /tmp/uploads_backup uploads
              echo "‚úÖ Uploads restored"
            else
              mkdir -p uploads/chat-files uploads/certificates uploads/videos
            fi
            
            if [ -f "/tmp/env_backup" ]; then
              cp /tmp/env_backup .env
              echo "‚úÖ Environment file restored"
            else
              echo "‚ö†Ô∏è  WARNING: No .env file found! Please configure manually."
            fi
            
            # Install production dependencies
            echo "üì¶ Installing production dependencies..."
            export NODE_ENV=production
            npm ci --production --silent
            
            # Create necessary directories
            echo "üìÅ Creating directory structure..."
            mkdir -p uploads/chat-files uploads/certificates uploads/videos public logs
            chmod -R 755 uploads
            
            # Start application with PM2
            echo "üöÄ Starting application..."
            pm2 delete sgt-backend 2>/dev/null || true
            pm2 start server.js \
              --name sgt-backend \
              --time \
              --max-memory-restart 1G \
              --log logs/pm2.log \
              --error logs/pm2-error.log
            
            # Save PM2 configuration
            pm2 save
            
            # Wait for application to start
            echo "‚è≥ Waiting for application to start..."
            sleep 5
            
            # Show status
            echo ""
            echo "============================================"
            echo "üìä Deployment Status"
            echo "============================================"
            pm2 status
            echo ""
            echo "üìù Recent Logs:"
            pm2 logs sgt-backend --lines 30 --nostream || true
            echo ""
            echo "‚úÖ Backend deployment completed successfully!"

      - name: üè• Health Check
        run: |
          echo "‚è≥ Waiting for application to be ready..."
          sleep 15
          
          echo "üè• Performing health check..."
          BACKEND_URL="http://${{ secrets.EC2_HOST }}:5000"
          
          # Try health endpoint
          response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$BACKEND_URL/api/health" || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "‚úÖ Health check passed! Backend is responding correctly."
          else
            echo "‚ö†Ô∏è  Health check returned HTTP $response"
            echo "Trying root endpoint..."
            root_response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$BACKEND_URL/" || echo "000")
            if [ "$root_response" = "200" ] || [ "$root_response" = "404" ]; then
              echo "‚úÖ Backend is responding (HTTP $root_response)"
            else
              echo "‚ùå Backend may not be responding correctly"
              echo "Please check PM2 logs on EC2"
            fi
          fi

  # =====================================================
  # JOB 4: Deploy Frontend to S3
  # =====================================================
  deploy-frontend:
    name: üöÄ Deploy Frontend to S3
    needs: build-frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend-build

      - name: üîê Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üì§ Sync to S3 bucket
        run: |
          echo "============================================"
          echo "üöÄ Deploying Frontend to S3"
          echo "============================================"
          
          BUCKET_NAME="${{ secrets.S3_BUCKET_NAME }}"
          echo "Bucket: $BUCKET_NAME"
          
          # Sync static assets with long cache
          echo "üì¶ Uploading static assets..."
          aws s3 sync frontend-build/ s3://$BUCKET_NAME/ \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "service-worker.js" \
            --exclude "manifest.json" \
            --exclude "asset-manifest.json"
          
          # Upload index.html with no-cache
          echo "üìÑ Uploading index.html..."
          aws s3 cp frontend-build/index.html s3://$BUCKET_NAME/index.html \
            --cache-control "public, max-age=0, must-revalidate" \
            --content-type "text/html"
          
          # Upload service-worker.js if exists
          if [ -f "frontend-build/service-worker.js" ]; then
            echo "üîß Uploading service worker..."
            aws s3 cp frontend-build/service-worker.js s3://$BUCKET_NAME/service-worker.js \
              --cache-control "public, max-age=0, must-revalidate" \
              --content-type "application/javascript"
          fi
          
          # Upload manifest.json if exists
          if [ -f "frontend-build/manifest.json" ]; then
            echo "üìã Uploading manifest..."
            aws s3 cp frontend-build/manifest.json s3://$BUCKET_NAME/manifest.json \
              --cache-control "public, max-age=3600" \
              --content-type "application/json"
          fi
          
          echo "‚úÖ Frontend uploaded to S3 successfully!"

      - name: üîÑ Invalidate CloudFront Cache
        if: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID != '' }}
        run: |
          echo "üîÑ Invalidating CloudFront cache..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "‚úÖ CloudFront invalidation created: $INVALIDATION_ID"
          echo "‚è≥ Note: Invalidation may take 1-2 minutes to complete"

      - name: üéâ Frontend Deployment Summary
        run: |
          echo ""
          echo "============================================"
          echo "‚úÖ Frontend Deployment Complete"
          echo "============================================"
          echo "Bucket: ${{ secrets.S3_BUCKET_NAME }}"
          echo "Region: ${{ env.AWS_REGION }}"
          echo "Files synced successfully"
          echo ""

  # =====================================================
  # JOB 5: Deployment Summary
  # =====================================================
  deployment-summary:
    name: üìä Deployment Summary
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üéâ Deployment Success
        if: needs.deploy-backend.result == 'success' && needs.deploy-frontend.result == 'success'
        run: |
          echo ""
          echo "============================================"
          echo "üéâ DEPLOYMENT SUCCESSFUL!"
          echo "============================================"
          echo ""
          echo "‚úÖ Backend deployed to EC2"
          echo "   ‚Ä¢ Host: ${{ secrets.EC2_HOST }}"
          echo "   ‚Ä¢ Application: Running with PM2"
          echo ""
          echo "‚úÖ Frontend deployed to S3"
          echo "   ‚Ä¢ Bucket: ${{ secrets.S3_BUCKET_NAME }}"
          echo "   ‚Ä¢ Cache invalidated"
          echo ""
          echo "üìã Deployment Details:"
          echo "   ‚Ä¢ Commit: ${{ github.sha }}"
          echo "   ‚Ä¢ Branch: ${{ github.ref_name }}"
          echo "   ‚Ä¢ Triggered by: ${{ github.actor }}"
          echo "   ‚Ä¢ Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "============================================"

      - name: ‚ùå Deployment Failure
        if: needs.deploy-backend.result == 'failure' || needs.deploy-frontend.result == 'failure'
        run: |
          echo ""
          echo "============================================"
          echo "‚ùå DEPLOYMENT FAILED"
          echo "============================================"
          echo ""
          echo "Backend Status: ${{ needs.deploy-backend.result }}"
          echo "Frontend Status: ${{ needs.deploy-frontend.result }}"
          echo ""
          echo "Please check the logs above for error details."
          echo "============================================"
          exit 1

      - name: ‚ö†Ô∏è Partial Deployment
        if: (needs.deploy-backend.result == 'success' && needs.deploy-frontend.result != 'success') || (needs.deploy-backend.result != 'success' && needs.deploy-frontend.result == 'success')
        run: |
          echo ""
          echo "============================================"
          echo "‚ö†Ô∏è  PARTIAL DEPLOYMENT"
          echo "============================================"
          echo ""
          echo "Backend Status: ${{ needs.deploy-backend.result }}"
          echo "Frontend Status: ${{ needs.deploy-frontend.result }}"
          echo ""
          echo "One component deployed successfully, but another failed."
          echo "Please review and fix the failing component."
          echo "============================================"
